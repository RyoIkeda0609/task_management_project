# ai_refactor_manual.md

AI主導リファクタリング実行マニュアル

目的：
既存のアーキテクチャ思想・仕様・テスト保証を壊さずに、
コードの可読性・単純性・意図の明確さを最大化する。

これは改善ではあるが、**再設計ではない。**
振る舞いを変えたら失敗である。

---

# 🎯 成功の定義

- 全テストが通る
- 依存方向が変わらない
- public API が変わらない
- しかしコードは読みやすくなる

---

# ❌ AIがやりがちな致命的ミス

先に潰す。

1. 良かれと思って仕様を直す
2. 重複を消すために責務を移動させる
3. 名前を変えたついでに意味を変える
4. 共通化のために抽象度を上げすぎる

全部ダメ。

今回は**美化**であって**改革**ではない。

---

# 🧠 リファクタリングの基本原理

> 外から見える動作は 1bit も変えてはいけない。

変えていいのは：

- 読みやすさ
- 長さ
- 名前
- ネスト
- 重複

だけ。

---

# 🪜 安全な進め方（必ず守る順序）

---

## Step 0：テスト実行

現在の成功状態を確認。
赤ならスタート不可。

---

## Step 1：小さく直す

1回の変更は小さく。
PR単位で意味が追えるサイズに。

---

## Step 2：即テスト

変更後すぐ確認。
失敗したら戻す。

---

## Step 3：次へ進む

---

# 🔥 優先度の高い改善対象

---

## 1. 長すぎるメソッド

### 判断基準

- スクロールが必要
- 複数の話題が混在

### 対応

プライベートメソッドへ分割。

---

## 2. 深いネスト

### 対応

早期 return を使う。

---

### before

```dart
if (a) {
  if (b) {
    action();
  }
}
```

### after

```dart
if (!a) return;
if (!b) return;
action();
```

---

## 3. 意味の弱い名前

process / handle / update は禁止。

動詞 + 対象 + 結果 へ。

---

## 4. 一時変数の削減

追跡コストを減らす。

---

## 5. コメント依存のコード

コメントがないと分からないなら
名前が悪い。

---

# 🧨 触ってはいけない領域

AI が最も壊しやすい。

- Entity の不変条件
- 進捗計算
- Repository interface
- UseCase の入出力

ここは変更禁止。
整理のみ。

---

# 🧪 リファクタ後の追加確認

AIは以下を自己点検する。

- 行数は減ったか？
- ネストは浅くなったか？
- 意図は明確か？
- コメントが減ったか？

YESでなければ再実施。

---

# ✨ 良いリファクタの兆候

レビュー時：

「何も起きていないのに読みやすくなった」

これが最高。

---

# 🚫 失敗例

- 賢くなった
- 抽象化が増えた
- 理解コストが上がった

全部失敗。

---

# 🎯 最終ゴール

- 新しい人が速く読める
- バグを入れにくい
- 変更に強い

この状態に近づける。
