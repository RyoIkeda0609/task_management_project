# ENGINEERING CONSTITUTION

（設計憲法 / 実装規約 / レビュー基準）

この文書は本プロジェクトにおける
最上位の技術的意思決定である。

迷ったらこの文書に従う。
従えない変更は誤りである。

---

## 🎯 我々が守るもの

このアプリの価値は以下にある。

- 構造が強制されていること
- 思考をユーザーに委ねること
- 進捗が自動計算されること
- 責務が明確であること

これを壊す実装は
どれだけ便利でも不正解。

---

## 🧱 アーキテクチャ原則

依存方向は常に：

Presentation → Application → Domain  
Infrastructure → Domain

逆流は禁止。

---

## 🧠 Domain の規約（最重要）

### Domain の役割

ビジネスルールの唯一の所在。

### Domain に入れてはいけないもの

- Flutter
- Riverpod
- Hive
- JSON
- API
- UI文言
- 非同期制御

### なぜダメか

Domain が技術に依存すると、
技術変更 = 仕様変更 になる。

それは破滅。

---

### Domain が必ず持つもの

- 不変条件
- 状態遷移の正当性
- 集約ルール

---

### 禁止事項

❌ 外部都合で Entity を変更  
❌ UI 表示のための getter  
❌ 保存形式への最適化

---

---

## ⚙️ Application（UseCase）の規約

### 役割

「ユーザーの操作単位」を実現する。

### やってよいこと

- Entity を作る
- Domain を呼ぶ
- Repository に保存

以上。

---

### やってはいけないこと

❌ UI メッセージ生成  
❌ loading 制御  
❌ retry  
❌ 並び替え  
❌ 表示用整形

---

### なぜダメか

UI が変わるたびに UseCase が壊れる。
寿命が短くなる。

---

### 正しい状態

UseCase は CLI から呼ばれても成立する。

---

---

## 🗄 Infrastructure の規約

### 役割

保存と取得。

### やってはいけない

❌ progress 計算  
❌ 並び替え  
❌ 不足値補完  
❌ 状態補正

---

### なぜダメか

意味解釈を始めると、
Domain が不要になる。

---

---

## 🎨 Presentation / Riverpod の規約

ここが最も腐る。

---

### 役割

翻訳。

UseCase を呼び、
結果を UI に流す。

---

### やってはいけない

❌ 業務ルールの判断  
❌ 成功条件の定義  
❌ progress 操作  
❌ 構造変更

---

### なぜダメか

ここにロジックが溜まると、
全てが崩れる。

---

---

## 🧪 テスト規約

### 悪いテスト

- getter を確認
- 成功することだけを見る

### 良いテスト

- 壊したら怒られる

---

### 必須担保項目

- 構造を飛び越えられない
- 手動進捗変更不可
- 不正な親参照不可

---

---

## 🚨 レビュー拒否条件

以下のいずれかを満たすPRは拒否。

- Domain に外部依存
- UseCase が UI 都合を持つ
- Provider が判断している
- Repository が賢い
- テストが思想を守っていない

---

---

## 🧭 迷ったときの判断基準

「それは誰の責務か？」

答えられなければ設計違反。

---

---

## 🏁 目標状態

- Provider が薄い
- UseCase が短い
- Repository が無知
- Domain が王様

これが完成形。
