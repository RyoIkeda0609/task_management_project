# architecture_review.md

本ドキュメントは、現時点の実装に対する **製品版前提の公式レビュー結果** である。  
目的は感想ではなく、将来の保守・拡張・AI開発に耐えるための **遵守ルールの明文化** にある。

レビュー観点：

- 機能が思想・要件どおりか
- Clean Architecture が成立しているか
- レイヤー責務が守られているか
- テストが仕様を守れているか

---

# 1. 総合評価（Executive Summary）

結論から述べる。

**設計レベルは高い。**  
しかし、いくつかの箇所で

- Presentation が Application に侵食する兆候
- Repository / UseCase の責務拡大リスク
- テストの保証範囲不足

が確認できる。

今すぐ全面崩壊する構造ではないが、  
**ルールを決めずに拡張すると高確率で腐る**。

このドキュメントはそれを防ぐためのもの。

---

# 2. 良い点（必ず維持すること）

- lib 配下に domain / application / infrastructure / presentation が分離されている
- Repository interface による依存逆転が意識されている
- Domain 主導で進捗計算を行う思想が維持されている
- テストフォルダがレイヤーを意識して配置されている

これらはこのプロジェクトの資産であり、絶対に崩さない。

---

# 3. レイヤー別レビュー

---

## 3.1 Domain

### 状態

概ね良好。  
アプリ固有ルールは Domain に集約されている。

### リスク

- DTO的な責務（変換・整形）が将来入り込みやすい
- ID や生成戦略が外部都合で侵食される可能性

### 厳守ルール

- JSON / Hive / API 型は絶対に入れない
- UI文言を持たせない
- Repository や Provider を import しない

---

## 3.2 Application（UseCase）

### 状態

UseCase を通す流れは良い。

### リスク

Provider や UI 都合の分岐（loading / retry 等）が入り込む余地が見える。

### 厳守ルール

UseCase は：

- 入力を受け取る
- Domain を生成 / 更新する
- Repository に保存する

ここまで。

以下は禁止：

- AsyncValue
- BuildContext
- 表示用メッセージ生成
- リトライ判断

---

## 3.3 Infrastructure

### 状態

Repository 実装の分離は評価できる。

### リスク

進捗計算や並び替えなどの「意味解釈」を入れ始める危険。

### 厳守ルール

Infrastructure は保存と取得のみ。
意味を与えるな。

---

## 3.4 Presentation（Riverpod）

### 状態

UseCase を呼び出す構造は良い。

### リスク

最も危険な層。  
機能追加のたびにロジックが集まりやすい。

### 厳守ルール

Provider は翻訳者。
判断するな。

---

# 4. テストレビュー

### 現状

テストは存在する。これは良い。

しかし：

- 思想違反を落とすテスト
- 構造破壊を検出するテスト

は十分とは言えない。

### 必須追加

- Goal 直下に Task を作れない
- 進捗を外部から変更できない
- 親を跨ぐ操作ができない

---

# 5. 実装ルール（AI・開発者向け）

今後の実装は以下を満たさない限りレビューを通過しない。

1. Domain を汚していないか？
2. UseCase を太らせていないか？
3. Provider に判断を書いていないか？
4. Repository が意味解釈していないか？

---

# 6. 優先度付き修正指針

### 高

- Application / Presentation の責務境界の固定

### 中

- テストの失敗系強化

### 低

- 命名・配置の微調整

---

# 最後に

このプロジェクトは既に「ちゃんと設計しようとしている」。
だからこそ、ルールで守れば強いプロダクトになる。

守れなければ、普通に崩れる。
