# バグ修正依頼書 Phase2

Presentation / 状態同期 修正フェーズ

---

# 🎯 目的

UI上の表示と内部状態が一致しない問題を解消する。

現在、
更新・削除・編集が一部の画面にしか反映されない現象が多数発生している。

これらは

- 状態の購読漏れ
- Providerの再取得不足
- Controllerのライフサイクル不正
- navigate後のrefresh不足

が原因である可能性が高い。

---

# ❗ 絶対ルール

修正は Presentation 層のみで行う。

以下の変更は禁止：

- Domain
- UseCase
- Repository
- 進捗計算
- ID仕様

---

---

# 🐞 バグ一覧

---

## 1. カスケード削除後に今日のタスクへ残る

### 現象

Goal削除 → Today画面にTaskが残る。

### 原因候補

- 削除後に一覧の再取得が走っていない
- Providerが古いstateを保持している

### 必須修正

削除成功後、
Today用Providerを invalidate / refresh する。

### 完了判定

削除 → 即一覧から消える。

---

---

## 2. カレンダービュー例外

### エラー

StateNotifier 更新時に listener が例外。

### 原因候補

- null前提の値アクセス
- dispose 済みに更新
- 非同期更新中の build

### 必須修正

- state更新前に mounted / dispose確認
- null安全を徹底

### 完了判定

遷移・再描画を繰り返しても落ちない。

---

---

## 3. バリデーション文言不一致

### 現象

ゴールのドメインでは100文字制限なのにUIでは 500 と表示。

### 必須修正

Domainルールに合わせる。

### 完了判定

制限値が仕様と一致。

---

---

## 4. ゴール作成画面から「キャンセル」を押して戻ると真っ暗

### 原因候補

- pop後の遷移先未定義
- root navigator不整合

### 必須修正

戻り先が常に存在するルーティングへ修正。

---

---

## 5〜7. 編集画面の初期値（超重要）

### 現象

- 表示されない
- 別のデータが入る

### 原因

Controller が Provider の変更と同期していない。

---

### 禁止

buildのたびに controller = new すること。

---

### 必須修正

- initState または初回 build のみでセット
- 対象ID変更時にのみ更新

---

### 完了判定

常に正しいEntityが表示される。

---

---

## 8. ボタンがぐるぐる

### 原因

loading state が解除されていない。

### 必須修正

success / error の両方で loading を false に戻す。

---

---

## 9. 入力のたびにキーボードが閉じる

### 原因

- rebuild時に Focus が失われている
- controller 再生成

---

### 必須修正

controller を保持する。

---

---

## 10. ステータス不一致

### 現象

画面ごとに表示が違う。

### 原因

異なる Provider を参照している。

---

### 必須修正

共通の Task 一覧ソースへ統一。

---

---

## 11. 進捗が反映されない

### 原因

変更後に再フェッチされない。

---

### 必須修正

更新成功後に GoalList を refresh。

---

---

# AIの修正原則（最重要）

状態変更後は必ず

- invalidate
- refresh
- watch

のいずれかで再取得される構造にする。

---

---

# 修正完了チェック

- どの画面で変更しても全画面に反映
- 再起動後も一致
- 遷移を繰り返しても落ちない
